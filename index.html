<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ariadne</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-item:hover {
            background-color: #374151;
        }
        .hidden { display: none; }
        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 40;
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        /* D3 Sitemap Styles */
        .sitemap-container .link {
            fill: none;
            stroke: #555;
            stroke-width: 1.5px;
        }
        .sitemap-container .node circle {
            fill: #1f2937;
            stroke: #3b82f6;
            stroke-width: 2px;
        }
        .sitemap-container .node text {
            font-size: 12px;
            fill: #d1d5db;
        }
        .sitemap-container .node {
            cursor: pointer;
        }
        /* Diff Viewer Styles */
        #diff-output table {
            width: 100%;
            border-collapse: collapse;
        }
        #diff-output th {
            background-color: #374151;
            padding: 8px;
            text-align: left;
        }
        #diff-output td {
            padding: 8px;
            border-top: 1px solid #4b5563;
            font-family: monospace;
            white-space: pre-wrap;
        }
        #diff-output .diff_add { background-color: #166534; }
        #diff-output .diff_sub { background-color: #991b1b; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app-container" class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <div class="w-28"></div> <!-- Spacer -->
            <div class="text-center flex-grow">
                <h1 class="text-3xl font-bold text-gray-100">Ariadne</h1>
                <p class="text-gray-400 mt-1">A comprehensive tool for site and subdomain discovery.</p>
            </div>
            <div class="flex items-center space-x-2 w-auto justify-end">
                 <button id="archives-btn" class="bg-gray-700 text-white p-2 rounded-md hover:bg-gray-600 transition" title="View Local Archives">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                    </svg>
                 </button>
                 <button id="history-btn" class="bg-gray-700 text-white p-2 rounded-md hover:bg-gray-600 transition" title="Load Last Scan Results">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                 </button>
                <button id="scheduler-btn" class="bg-gray-700 text-white p-2 rounded-md hover:bg-gray-600 transition" title="Scheduler">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </button>
                <button id="about-btn" class="bg-gray-700 text-white p-2 rounded-md hover:bg-gray-600 transition" title="About this Tool">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </button>
                <button id="settings-btn" class="bg-gray-700 text-white p-2 rounded-md hover:bg-gray-600 transition" title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 16v-2m0-8v4m-4-2h8m-8 6h8m-8-12h8m-4-4v2m0 16v-2m0-8v4m-4-2h8m-8 6h8m-8-12h8" /></svg>
                </button>
            </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <input type="text" id="url-input" placeholder="Enter a URL or domain (e.g., https://example.com)" class="flex-grow w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-200 border-gray-600">
                <div class="flex items-center gap-2">
                    <label for="depth-input" class="text-sm font-medium">Depth:</label>
                    <span class="cursor-help text-gray-400 font-bold" title="Scan depth determines how many 'clicks' deep the scanner will go.">[?]</span>
                    <input type="number" id="depth-input" value="1" min="1" max="5" class="w-20 px-3 py-2 border rounded-md bg-gray-700 text-gray-200 border-gray-600">
                </div>
            </div>
            <div class="flex items-center mt-3">
                <input type="checkbox" id="follow-external-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="follow-external-checkbox" class="ml-2 text-sm text-gray-300">Follow External Links</label>
            </div>
            <div class="flex items-center mt-3">
                <input type="checkbox" id="brute-force-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="brute-force-checkbox" class="ml-2 text-sm text-gray-300">Enable Brute-Force (Subdomain Scans)</label>
            </div>
            <p class="text-xs text-yellow-400 mt-3 text-center sm:text-left">Note: Scans with a depth greater than 1 or with brute-force enabled may take significantly longer.</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                <button id="scan-button" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">Scan Site</button>
                <button id="subdomain-button" class="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition">Find Subdomains</button>
            </div>
        </div>

        <div id="loading-spinner" class="hidden my-6 flex justify-center"><div class="spinner"></div></div>
        <p id="error-message" class="my-4 text-center text-red-500 font-medium"></p>
        
        <div id="results-container" class="bg-gray-800 mt-6 p-6 rounded-lg shadow-lg border border-gray-700 hidden">
            <div class="flex justify-between items-center mb-4">
                 <div class="flex items-center">
                    <h2 class="text-2xl font-bold text-gray-100" id="results-title">Results</h2>
                    <div id="select-all-container" class="ml-6 hidden">
                        <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="select-all-checkbox" class="ml-2 text-sm text-gray-300">Select All</label>
                    </div>
                </div>
                <div class="flex gap-2 flex-wrap justify-end">
                    <button id="sitemap-btn" class="hidden bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700 transition">View Map</button>
                    <button id="export-csv-btn" class="hidden bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">Export Selected</button>
                    <button id="save-all-local-btn" class="hidden bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">Save All Local</button>
                    <button id="archive-all-btn" class="hidden bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition">Archive</button>
                </div>
            </div>
            <p class="text-gray-400 mb-4" id="results-summary"></p>
            <div id="results-list" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div>
        </div>

        <!-- Analysis Section -->
        <div id="analysis-container" class="bg-gray-800 mt-6 p-6 rounded-lg shadow-lg border border-gray-700 hidden">
             <h2 class="text-2xl font-bold text-gray-100 mb-4">Analysis Tools</h2>
             <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                 <button id="diff-main-btn" class="w-full bg-teal-600 text-white py-2 rounded-md hover:bg-teal-700 transition">Diff (Main URL)</button>
                 <button id="tech-btn" class="w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700 transition">Detect Tech (Main URL)</button>
                 <button id="headers-btn" class="w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700 transition">Analyze Headers (Main URL)</button>
                 <button id="links-btn" class="w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700 transition">Check All For Broken Links</button>
             </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="sitemap-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 h-5/6">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-xl font-bold" id="sitemap-modal-title">Visual Sitemap</h3>
                <button id="close-sitemap-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="sitemap-container" class="relative w-full h-full p-4 overflow-auto sitemap-container">
                <div id="sitemap-legend" class="absolute top-2 left-2 bg-gray-900 bg-opacity-80 p-3 rounded-md text-xs text-gray-300 border border-gray-700 z-10"></div>
                <svg id="sitemap-svg" width="100%"></svg>
            </div>
        </div>
    </div>
    
    <div id="analysis-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/2">
             <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-xl font-bold" id="analysis-modal-title">Analysis Results</h3>
                <button id="close-analysis-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="analysis-modal-body" class="p-6 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <div id="settings-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/2 max-h-[80vh] flex flex-col">
             <div class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
                <h3 class="text-xl font-bold">Settings</h3>
                <button id="close-settings-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto">
                <div>
                    <h4 class="text-lg font-semibold text-gray-100 mb-2">Proxy Settings</h4>
                    <label for="proxy-textarea" class="block text-sm font-medium text-gray-300 mb-2">Enter proxies, one per line (e.g., http://user:pass@host:port)</label>
                    <textarea id="proxy-textarea" rows="5" class="w-full p-2 border rounded-md bg-gray-700 text-gray-200 border-gray-600"></textarea>
                    
                    <div id="proxy-test-results-container" class="mt-4 hidden">
                        <h5 class="text-md font-semibold text-gray-200 mb-2">Proxy Test Results:</h5>
                        <div id="proxy-test-results" class="max-h-32 overflow-y-auto p-3 bg-gray-900 rounded-md border border-gray-700 text-sm space-y-1">
                        </div>
                    </div>
                    
                    <div class="flex items-center my-4">
                        <input type="checkbox" id="enable-proxies-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="enable-proxies-checkbox" class="ml-2 text-sm text-gray-300">Enable Proxies for Archiving</LabeL>
                    </div>
                </div>
                
                <div class="border-t border-gray-700 pt-4">
                     <h4 class="text-lg font-semibold text-gray-100 mb-2">Archive Settings</h4>
                     <label for="archive-folder-input" class="block text-sm font-medium text-gray-300 mb-2">Local Archive Subfolder (e.g., "my-domain")</label>
                    <input type="text" id="archive-folder-input" placeholder="Leave blank to save in main archive" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-200 border-gray-600">
                </div>

                <!-- NEW: Auth Cookie Settings -->
                <div class="border-t border-gray-700 pt-4">
                     <h4 class="text-lg font-semibold text-gray-100 mb-2">Authentication Settings</h4>
                     <p class="text-xs text-gray-400 mb-3">
                        For scanning sites that require login. Find these in your browser's DevTools (Application > Cookies).
                     </p>
                     <div class="space-y-3">
                        <div>
                            <label for="cookie-domain-input" class="block text-sm font-medium text-gray-300 mb-1">Auth Domain (e.g., .example.com)</label>
                            <input type="text" id="cookie-domain-input" placeholder=".example.com" class="w-full px-4 py-2 border rounded-md bg-gray-700 text-gray-200 border-gray-600">
                        </div>
                        <div>
                            <label for="cookie-name-input" class="block text-sm font-medium text-gray-300 mb-1">Cookie Name (e.g., sessionid)</label>
                            <input type="text" id="cookie-name-input" placeholder="sessionid" class="w-full px-4 py-2 border rounded-md bg-gray-700 text-gray-200 border-gray-600">
                        </div>
                        <div>
                            <label for="cookie-value-input" class="block text-sm font-medium text-gray-300 mb-1">Cookie Value</label>
                            <input type="text" id="cookie-value-input" placeholder="abc123..." class="w-full px-4 py-2 border rounded-md bg-gray-700 text-gray-200 border-gray-600">
                        </div>
                     </div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-700 mt-auto flex-shrink-0">
                <p id="settings-status-message" class="text-sm mb-3 text-center"></p>
                <div class="flex flex-col sm:flex-row justify-end gap-3">
                    <button id="test-proxies-btn" class="bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700 transition">Test Proxies</button>
                    <button id="save-settings-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <div id="about-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-2/3">
             <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-xl font-bold">About Ariadne</h3>
                <button id="close-about-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <!-- UPDATED ABOUT SECTION -->
            <div id="about-modal-body" class="p-6 max-h-[70vh] overflow-y-auto space-y-4">
                <div>
                    <h4 class="text-lg font-semibold text-gray-100">Main Scanning Features</h4>
                    <p class="text-sm mt-1"><strong>Scan Site:</strong> Initiates a comprehensive scan to find all pages of a website. This scan uses a stealth-enabled browser to bypass anti-bot services, find sitemaps, and parse JavaScript files for hidden links. It automatically handles dynamic content and "infinite scroll" pages by intelligently scrolling until no new content is loaded.</p>
                    <p class="text-sm mt-1"><strong>Find Subdomains:</strong> Discovers subdomains using passive sources (Google, Certificate Logs, ThreatCrowd) and active DNS enumeration (Zone Transfers, Brute-Force). All results are validated with a robust, custom DNS resolver to ensure they are live.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-100">Scan Options</h4>
                    <p class="text-sm mt-1"><strong>Depth:</strong> Controls how many 'layers' deep the 'Scan Site' crawler will go. A depth of 1 scans the starting page. A depth of 2 scans that page and every page it links to.</p>
                    <p class="text-sm mt-1"><strong>Follow External Links:</strong> Allows the 'Scan Site' crawler to follow hyperlinks to different websites.</p>
                    <p class="text-sm mt-1"><strong>Enable Brute-Force:</strong> Enables the active (and slower) brute-force scan when finding subdomains.</p>
                </div>
                 <div>
                    <h4 class="text-lg font-semibold text-gray-100">Results & Actions</h4>
                    <p class="text-sm mt-1"><strong>Results List:</strong> Displays all pages or subdomains found. You can select items individually or use "Select All".</p>
                    <p class="text-sm mt-1"><strong>Export Selected:</strong> Saves the selected items to a CSV file.</p>
                    <p class="text-sm mt-1"><strong>Archive Selected:</strong> Submits the selected items to be permanently saved on the <a href="https://archive.org/" target="_blank" class="text-blue-400 hover:underline">Internet Archive</a>. This uses proxies if they are enabled.</p>
                    <p class="text-sm mt-1"><strong>Save All Local:</strong> Creates a complete, self-contained offline copy of the selected pages, embedding all CSS, images, and scripts. This also uses the stealth browser to capture the full page.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-100">Change Detection</h4>
                    <p class="text-sm mt-1"><strong>Check for Changes (Diff):</strong> This feature compares the live version of a page against its most recent snapshot on the Internet Archive. It uses the stealth-enabled browser (with your auth cookie, if set) to get the *true* live content, providing an accurate comparison. It then displays a side-by-side diff highlighting all changes.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-100">Visual Maps</h4>
                    <p class="text-sm mt-1"><strong>View Map:</strong> Generates an interactive D3.js sitemap or subdomain map. Nodes are clickable and will open the corresponding URL in a new tab. The legend provides scan info like IP address, domain provider, and scan time.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-100">Analysis Tools</h4>
                    <p class="text-sm mt-1"><strong>Detect Tech:</strong> Identifies web technologies (e.g., WordPress, React) used on the main URL.</p>
                    <p class="text-sm mt-1"><strong>Analyze Headers:</strong> Inspects the main URL's HTTP response for important security headers.</p>
                    <p class="text-sm mt-1"><strong>Check All For Broken Links:</strong> Concurrently tests every link found during a site scan and categorizes them by status code (e.g., 404) or network errors.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-100">Automated Scanning</h4>
                     <p class="text-sm mt-1"><strong>Scan Scheduler:</strong> Transforms the tool into an automated monitoring system. You can schedule recurring jobs to automatically find subdomains, run a diff check on each one, and archive any that have changed. Schedules are persistent and can be set to run daily, weekly, etc.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-100">Configuration (Settings)</h4>
                    <p class="text-sm mt-1"><strong>Proxy Settings:</strong> Add a list of proxies to be used for archiving. The "Test Proxies" button will validate your list in parallel and report which ones are working.</p>
                    <p class="text-sm mt-1"><strong>Archive Settings:</strong> Specify a subfolder name to organize your locally saved HTML files.</p>
                    <p class="text-sm mt-1"><strong>Authentication Settings:</strong> Inject a session cookie (Domain, Name, Value) into the browser. This allows the "Scan Site", "Save Local Copy", and "Diff" features to work on sites that require you to be logged in.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-100">Convenience Features</h4>
                    <p class="text-sm mt-1"><strong>Load Last Scan Results:</strong> Instantly reload the results of your most recent subdomain scan without running it again.</p>
                    <p class="text-sm mt-1"><strong>View Local Archives:</strong> Opens a modal that lists all your locally saved HTML files, allowing you to open them directly.</p>
                </div>
            </div>
            <!-- END UPDATED ABOUT SECTION -->
        </div>
    </div>
    
    <div id="diff-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 h-5/6 flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-xl font-bold" id="diff-modal-title">Site Changes</h3>
                <button id="close-diff-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="diff-output" class="p-6 overflow-y-auto flex-grow"></div>
            <div id="diff-modal-footer" class="p-4 border-t border-gray-700 text-center">
                <p id="diff-summary" class="mb-4"></p>
                <button id="archive-new-version-btn" class="hidden bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">Archive New Version</button>
            </div>
        </div>
    </div>

    <div id="scheduler-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-2/3">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-xl font-bold">Scan Scheduler</h3>
                <button id="close-scheduler-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-6 border-b border-gray-700 pb-6">
                    <h4 class="text-lg font-semibold mb-3">Add New Schedule</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="schedule-domain-input" placeholder="Enter domain (e.g., example.com)" class="px-4 py-2 border rounded-md bg-gray-700 text-gray-200 border-gray-600">
                        <input type="datetime-local" id="schedule-start-date" class="px-4 py-2 border rounded-md bg-gray-700 text-gray-200 border-gray-600">
                        <select id="schedule-frequency" class="px-4 py-2 border rounded-md bg-gray-700 text-gray-200 border-gray-600">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value-="bi-weekly">Bi-Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="every-other-month">Every Other Month</option>
                        </select>
                        <button id="save-schedule-btn" class="bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">Save Schedule</button>
                    </div>
                    <p id="schedule-status-message" class="text-sm mt-3"></p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-3">Current Schedules</h4>
                    <div id="scheduled-jobs-list" class="space-y-3 max-h-60 overflow-y-auto">
                        <!-- Scheduled jobs will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="local-archive-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-2/3">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-xl font-bold">Local Archives</h3>
                <button id="close-local-archive-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6">
                <div id="local-archives-list" class="space-y-3 max-h-80 overflow-y-auto">
                    <!-- Saved archives will be populated here -->
                </div>
            </div>
        </div>
    </div>


    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = 'http://127.0.0.1:5010';
        let currentResults = [];
        let scanSummaryData = null;
        let scanStartTime = 0;
        let currentScanType = '';
        let currentArchiveFolder = '';

        // DOM Elements
        const urlInput = document.getElementById('url-input');
        const depthInput = document.getElementById('depth-input');
        const followExternalCheckbox = document.getElementById('follow-external-checkbox');
        const bruteForceCheckbox = document.getElementById('brute-force-checkbox');
        const scanButton = document.getElementById('scan-button');
        const subdomainButton = document.getElementById('subdomain-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsContainer = document.getElementById('results-container');
        const resultsTitle = document.getElementById('results-title');
        const resultsSummary = document.getElementById('results-summary');
        const resultsList = document.getElementById('results-list');
        const errorMessage = document.getElementById('error-message');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const archiveAllBtn = document.getElementById('archive-all-btn');
        const saveAllLocalBtn = document.getElementById('save-all-local-btn');
        const sitemapBtn = document.getElementById('sitemap-btn');
        const analysisContainer = document.getElementById('analysis-container');
        const techBtn = document.getElementById('tech-btn');
        const headersBtn = document.getElementById('headers-btn');
        const linksBtn = document.getElementById('links-btn');
        const diffMainBtn = document.getElementById('diff-main-btn');
        const selectAllContainer = document.getElementById('select-all-container');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');

        // Modals
        const sitemapModal = document.getElementById('sitemap-modal');
        const closeSitemapModalBtn = document.getElementById('close-sitemap-modal-btn');
        const analysisModal = document.getElementById('analysis-modal');
        const closeAnalysisModalBtn = document.getElementById('close-analysis-modal-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalBtn = document.getElementById('close-settings-modal-btn');
        const aboutModal = document.getElementById('about-modal');
        const aboutBtn = document.getElementById('about-btn');
        const closeAboutModalBtn = document.getElementById('close-about-modal-btn');
        const diffModal = document.getElementById('diff-modal');
        const closeDiffModalBtn = document.getElementById('close-diff-modal-btn');
        const diffOutput = document.getElementById('diff-output');
        const diffSummary = document.getElementById('diff-summary');
        const archiveNewVersionBtn = document.getElementById('archive-new-version-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const proxyTextarea = document.getElementById('proxy-textarea');
        const enableProxiesCheckbox = document.getElementById('enable-proxies-checkbox');
        const archiveFolderInput = document.getElementById('archive-folder-input');
        const settingsStatusMessage = document.getElementById('settings-status-message');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const testProxiesBtn = document.getElementById('test-proxies-btn');
        const proxyTestResultsContainer = document.getElementById('proxy-test-results-container');
        const proxyTestResults = document.getElementById('proxy-test-results');
        
        // NEW: Auth Cookie Elements
        const cookieDomainInput = document.getElementById('cookie-domain-input');
        const cookieNameInput = document.getElementById('cookie-name-input');
        const cookieValueInput = document.getElementById('cookie-value-input');
        
        const schedulerModal = document.getElementById('scheduler-modal');
        const schedulerBtn = document.getElementById('scheduler-btn');
        const closeSchedulerModalBtn = document.getElementById('close-scheduler-modal-btn');
        const scheduleDomainInput = document.getElementById('schedule-domain-input');
        const scheduleStartDate = document.getElementById('schedule-start-date');
        const scheduleFrequency = document.getElementById('schedule-frequency');
        const saveScheduleBtn = document.getElementById('save-schedule-btn');
        const scheduleStatusMessage = document.getElementById('schedule-status-message');
        const scheduledJobsList = document.getElementById('scheduled-jobs-list');
        const historyBtn = document.getElementById('history-btn');
        const archivesBtn = document.getElementById('archives-btn');
        const localArchiveModal = document.getElementById('local-archive-modal');
        const closeLocalArchiveModalBtn = document.getElementById('close-local-archive-modal-btn');
        const localArchivesList = document.getElementById('local-archives-list');
        
        let originalResultsSummaryText = '';

        // Make functions globally available for onclick attributes
        window.runDiffCheck = async function(url, index) {
            let statusSpan = null;
            if (index !== -1) {
                statusSpan = document.getElementById(`status-${index}`);
                statusSpan.textContent = 'Checking...';
                statusSpan.className = 'text-sm font-medium text-yellow-500 flex-shrink-0';
            }

            diffOutput.innerHTML = '<div class="flex justify-center"><div class="spinner"></div></div>';
            diffSummary.textContent = 'Checking for changes...';
            archiveNewVersionBtn.classList.add('hidden');
            diffModal.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/check-diff`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url }),
                });
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.has_changes) {
                    diffOutput.innerHTML = data.diff_html;
                    diffSummary.textContent = 'Changes detected. Review the differences below.';
                    archiveNewVersionBtn.classList.remove('hidden');
                    archiveNewVersionBtn.onclick = () => {
                        closeDiffModalBtn.click();
                        archiveUrl(url, index);
                    };
                } else {
                    diffOutput.innerHTML = `<p class="text-center p-8 text-lg">${data.message || 'No changes found.'}</p>`;
                    diffSummary.textContent = data.message || 'No changes found.';
                }
                
                if (statusSpan) {
                    statusSpan.textContent = data.has_changes ? 'Changed' : 'Unchanged';
                    statusSpan.className = `text-sm font-medium ${data.has_changes ? 'text-green-500' : 'text-gray-500'} flex-shrink-0`;
                }

            } catch (err) {
                diffOutput.innerHTML = `<p class="text-red-500">${err.message}</p>`;
                diffSummary.textContent = `Error: ${err.message}`;
                if (statusSpan) {
                    statusSpan.textContent = 'Diff Error';
                    statusSpan.className = 'text-sm font-medium text-red-500 flex-shrink-0';
                }
            }
        }

        window.runSingleTechAnalysis = function(url) { runAnalysis('/detect-tech', `Technology Stack for ${url}`, { url }); }
        window.runSingleHeaderAnalysis = function(url) { runAnalysis('/analyze-headers', `Security Headers for ${url}`, { url }); }
        window.scanSubdomain = function(subdomain) {
            urlInput.value = subdomain;
            performStreamingScan();
        }

        window.deleteSchedule = async function(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/delete-schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id }),
                });
                const data = await response.json();
                if (response.ok) {
                    loadSchedules();
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (e) {
                alert('Failed to delete schedule.');
            }
        }
        
        window.saveLocalCopy = function(link, index) {
            return new Promise((resolve) => {
                let statusSpan = null;
                if (index !== -1) {
                    statusSpan = document.getElementById(`local-status-${index}`);
                }

                const updateStatus = (text, colorClass, title = '') => {
                    if (statusSpan) {
                        statusSpan.textContent = text;
                        statusSpan.className = `text-sm font-medium ${colorClass} flex-shrink-0 ml-2`;
                        statusSpan.title = title;
                    } else {
                        resultsSummary.textContent = text;
                        resultsSummary.className = `text-sm mb-4 ${colorClass}`;
                    }
                };

                updateStatus('Saving...', 'text-gray-400');

                const fullUrl = link.startsWith('http') ? link : `https://${link}`;
                const folder = archiveFolderInput.value;
                const eventSource = new EventSource(`${API_BASE_URL}/save-local-copy?url=${encodeURIComponent(fullUrl)}&folder=${encodeURIComponent(folder)}`);

                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    if (data.status) {
                        updateStatus(data.status, 'text-yellow-500');
                    }
                    if (data.success) {
                        updateStatus('Saved!', 'text-green-500', data.success);
                        eventSource.close();
                        resolve();
                    }
                    if (data.error) {
                        updateStatus('Failed!', 'text-red-500', data.error);
                        eventSource.close();
                        resolve();
                    }
                };
                eventSource.addEventListener('end', () => resolve());
                eventSource.onerror = () => {
                    updateStatus('Failed!', 'text-red-500', 'Connection error to the backend server.');
                    eventSource.close();
                    resolve();
                };
            });
        }

        function addResultItem(item, index) {
            const div = document.createElement('div');
            div.className = 'result-item flex items-center justify-between p-2 rounded transition';
            
            let displayName, linkUrl;
            let archiveStatusHtml = `<span id="status-${index}" class="text-sm font-medium text-gray-500 flex-shrink-0"></span>`;
            let localStatusHtml = `<span id="local-status-${index}" class="text-sm font-medium text-gray-500 flex-shrink-0 ml-2"></span>`;
            let actionsHtml = '';

            if (currentScanType === 'sitemap') {
                displayName = item;
                linkUrl = item;
                actionsHtml = `
                    <button onclick="saveLocalCopy('${linkUrl}', ${index})" class="ml-2 bg-blue-600 text-white px-2 py-1 text-xs rounded hover:bg-blue-700 transition" title="Save Local Copy">Save</button>
                    <button onclick="runDiffCheck('${linkUrl}', ${index})" class="ml-2 bg-teal-600 text-white px-2 py-1 text-xs rounded hover:bg-teal-700 transition" title="Check for Changes">Diff</button>
                    <button onclick="runSingleTechAnalysis('${linkUrl}')" class="ml-2 bg-gray-500 text-white px-2 py-1 text-xs rounded hover:bg-gray-600 transition" title="Detect Tech">Tech</button>
                    <button onclick="runSingleHeaderAnalysis('${linkUrl}')" class="ml-2 bg-gray-500 text-white px-2 py-1 text-xs rounded hover:bg-gray-600 transition" title="Analyze Headers">Headers</button>
                `;
            } else if (currentScanType === 'subdomain') {
                 displayName = `${item.name} <span class="text-xs text-gray-400 ml-2">(${item.type})</span>`;
                 linkUrl = item.name;
                 const fullSubdomainUrl = `https://${linkUrl}`;
                 actionsHtml = `
                    <button onclick="saveLocalCopy('${fullSubdomainUrl}', ${index})" class="ml-2 bg-blue-600 text-white px-2 py-1 text-xs rounded hover:bg-blue-700 transition" title="Save Local Copy">Save</button>
                    <button onclick="runDiffCheck('${fullSubdomainUrl}', ${index})" class="ml-2 bg-teal-600 text-white px-2 py-1 text-xs rounded hover:bg-teal-700 transition" title="Check for Changes">Diff</button>
                    <button onclick="runSingleTechAnalysis('${fullSubdomainUrl}')" class="ml-2 bg-gray-500 text-white px-2 py-1 text-xs rounded hover:bg-gray-600 transition" title="Detect Tech">Tech</button>
                    <button onclick="runSingleHeaderAnalysis('${fullSubdomainUrl}')" class="ml-2 bg-gray-500 text-white px-2 py-1 text-xs rounded hover:bg-gray-600 transition" title="Analyze Headers">Headers</button>
                    <button onclick="scanSubdomain('${linkUrl}')" class="ml-2 bg-blue-500 text-white px-2 py-1 text-xs rounded hover:bg-blue-600 transition">Scan</button>
                 `;
            } else {
                 displayName = (typeof item === 'string') ? item : item.name;
                 linkUrl = displayName;
            }
            
            const fullUrl = linkUrl.startsWith('http') ? linkUrl : `https://${linkUrl}`;

            div.innerHTML = `
                <div class="flex items-center truncate mr-4">
                    <input type="checkbox" class="result-checkbox h-4 w-4 rounded border-gray-600 bg-gray-700 text-indigo-600 focus:ring-indigo-500 mr-4" data-link='${linkUrl}'>
                    <a href="${fullUrl}" target="_blank" class="text-blue-500 hover:underline">${displayName}</a>
                </div>
                <div class="flex items-center flex-shrink-0">
                    ${archiveStatusHtml}
                    ${localStatusHtml}
                    ${actionsHtml}
                </div>
            `;
            
            resultsList.appendChild(div);
        }
        
        // --- Scheduler Functions ---
        async function loadSchedules() {
            try {
                const response = await fetch(`${API_BASE_URL}/get-schedules`);
                const jobs = await response.json();
                scheduledJobsList.innerHTML = '';
                if (jobs.length === 0) {
                    scheduledJobsList.innerHTML = '<p class="text-gray-400">No scans are currently scheduled.</p>';
                    return;
                }
                jobs.forEach(job => {
                    const nextRun = new Date(job.next_run).toLocaleString();
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700 p-3 rounded-md flex justify-between items-center';
                    div.innerHTML = `
                        <div>
                            <p class="font-semibold">${job.domain}</p>
                            <p class="text-xs text-gray-400">Next run: ${nextRun}</p>
                        </div>
                        <button onclick="deleteSchedule('${job.id}')" class="bg-red-600 text-white px-3 py-1 text-xs rounded hover:bg-red-700 transition">Delete</button>
                    `;
                    scheduledJobsList.appendChild(div);
                });
            } catch (e) {
                scheduledJobsList.innerHTML = '<p class="text-red-500">Could not load schedules.</p>';
            }
        }
        
        // --- All other existing JS functions ---

        function setUILoading(isLoading) {
            loadingSpinner.classList.toggle('hidden', !isLoading);
            scanButton.disabled = isLoading;
            subdomainButton.disabled = isLoading;
            if (isLoading) {
                errorMessage.textContent = '';
                resultsContainer.classList.add('hidden');
                analysisContainer.classList.add('hidden');
                scanSummaryData = null; 
            }
        }

        function showActionButtons(show) {
            const hasResults = currentResults.length > 0;
            exportCsvBtn.classList.toggle('hidden', !show);
            archiveAllBtn.classList.toggle('hidden', !show);
            saveAllLocalBtn.classList.toggle('hidden', !show);
            sitemapBtn.classList.toggle('hidden', !show);
            analysisContainer.classList.toggle('hidden', !show);
            selectAllContainer.classList.toggle('hidden', !hasResults); 
            updateActionButtonsState();
        }

        function updateActionButtonsState() {
            const selectedCount = document.querySelectorAll('.result-checkbox:checked').length;
            const hasResults = currentResults.length > 0;

            exportCsvBtn.disabled = selectedCount === 0;
            exportCsvBtn.classList.toggle('opacity-50', selectedCount === 0);

            const actionButtonsDisabled = hasResults && selectedCount === 0;
            
            archiveAllBtn.disabled = actionButtonsDisabled;
            archiveAllBtn.classList.toggle('opacity-50', actionButtonsDisabled);
            
            saveAllLocalBtn.disabled = actionButtonsDisabled;
            saveAllLocalBtn.classList.toggle('opacity-50', actionButtonsDisabled);

            if (selectedCount > 0) {
                archiveAllBtn.textContent = `Archive ${selectedCount} Selected`;
                saveAllLocalBtn.textContent = `Save ${selectedCount} Local`;
            } else if (!hasResults) {
                archiveAllBtn.textContent = 'Archive Base URL';
                saveAllLocalBtn.textContent = 'Save Base URL Local';
            } else {
                archiveAllBtn.textContent = 'Archive';
                saveAllLocalBtn.textContent = 'Save All Local';
            }
        }

        function displayStaticResults(title, items, summaryPrefix) {
            resultsContainer.classList.remove('hidden');
            resultsTitle.textContent = title;
            resultsList.innerHTML = ''; 
            originalResultsSummaryText = `${summaryPrefix} ${items.length} unique items.`;
            resultsSummary.textContent = originalResultsSummaryText;
            currentResults = items;

            showActionButtons(true);

            if (items.length === 0) {
                resultsList.innerHTML = '<p>No items found.</p>';
                return;
            }

            items.forEach((item, index) => {
                addResultItem(item, index);
            });
            updateActionButtonsState();
        }

        function getDomainName(url) {
            try {
                let fullUrl = url.trim();
                if (!/^[a-zA-Z]+:\/\//.test(fullUrl)) fullUrl = 'http://' + fullUrl;
                const hostname = new URL(fullUrl).hostname.replace(/^www\./, '');
                
                // Handle domain parts like .co.uk
                const parts = hostname.split('.');
                if (parts.length > 2 && parts[parts.length - 2].length <= 3 && parts[parts.length - 1].length <= 3) {
                     return parts.slice(-3).join('.');
                }
                return parts.slice(-2).join('.');
            } catch (error) {
                const parts = url.trim().replace(/^www\./, '').split('/')[0].split('.');
                 if (parts.length > 2 && parts[parts.length - 2].length <= 3 && parts[parts.length - 1].length <= 3) {
                     return parts.slice(-3).join('.');
                }
                return parts.slice(-2).join('.');
            }
        }

        async function fetchIpAddress(domain) {
            try {
                const response = await fetch(`${API_BASE_URL}/get-ip`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain }),
                });
                if (!response.ok) {
                    const errData = await response.json();
                    console.error("IP fetch error:", errData.error);
                    return 'Error';
                }
                const data = await response.json();
                return data.ip_address || 'Not found';
            } catch (err) { 
                console.error("IP fetch exception:", err);
                return 'N/A'; 
            }
        }

        async function fetchRegistrar(domain) {
            try {
                const response = await fetch(`${API_BASE_URL}/get-registrar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain }),
                });
                if (!response.ok) {
                     const errData = await response.json();
                     console.error("Registrar fetch error:", errData.error);
                     return 'Error';
                }
                const data = await response.json();
                return data.registrar || 'Not found';
            } catch (err) { 
                console.error("Registrar fetch exception:", err);
                return 'N/A'; 
            }
        }
        
        function performStreamingScan() {
            const url = urlInput.value;
            if (!url) {
                errorMessage.textContent = 'Please enter a URL.';
                return;
            }
            
            currentScanType = 'sitemap';
            setUILoading(true);
            resultsContainer.classList.remove('hidden');
            resultsTitle.textContent = 'Scan in Progress...';
            resultsSummary.textContent = 'Waiting for results...';
            originalResultsSummaryText = 'Waiting for results...';
            resultsList.innerHTML = '';
            currentResults = [];
            scanStartTime = Date.now();

            const followExternal = followExternalCheckbox.checked;
            const params = new URLSearchParams({ url, depth: depthInput.value, follow_external: followExternal });
            const eventSource = new EventSource(`${API_BASE_URL}/scan?${params.toString()}`);

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.error) {
                    errorMessage.textContent = `Error: ${data.error}`;
                    eventSource.close();
                    setUILoading(false);
                } else if (data.status) {
                     resultsSummary.textContent = data.status;
                     originalResultsSummaryText = data.status;
                } else if (data.link) {
                    if (!currentResults.includes(data.link)) {
                        currentResults.push(data.link);
                        addResultItem(data.link, currentResults.length - 1);
                        resultsSummary.textContent = `Found ${currentResults.length} unique items...`;
                        originalResultsSummaryText = `Found ${currentResults.length} unique items...`;
                    }
                }
            };

            eventSource.addEventListener('end', async function(event) {
                eventSource.close();
                setUILoading(false);
                const scanDuration = ((Date.now() - scanStartTime) / 1000).toFixed(2);
                resultsTitle.textContent = "Scan Complete";
                
                if(currentResults.length === 0) {
                    originalResultsSummaryText = `Scan finished in ${scanDuration}s. No items found. (Site may be protected or empty).`;
                } else {
                    originalResultsSummaryText = `Scan finished in ${scanDuration}s. Found ${currentResults.length} unique items.`;
                }
                resultsSummary.textContent = originalResultsSummaryText;
                
                const hostname = getDomainName(urlInput.value);
                const [ipAddress, registrar] = await Promise.all([ fetchIpAddress(hostname), fetchRegistrar(hostname) ]);

                scanSummaryData = { hostname, ip_address: ipAddress, registrar, page_count: currentResults.length, scan_duration: scanDuration };
                showActionButtons(true);
            });

            eventSource.onerror = function(err) {
                errorMessage.textContent = 'An error occurred. The connection may have been lost.';
                eventSource.close();
                setUILoading(false);
            };
        }
        
        async function performSubdomainSearch() {
            const url = urlInput.value;
            if (!url) {
                errorMessage.textContent = 'Please enter a domain.';
                return;
            }
            
            currentScanType = 'subdomain';
            setUILoading(true);
            const scanStartTime = Date.now();
            const bruteForce = bruteForceCheckbox.checked;
            const searchDomain = getDomainName(url);
            
            try {
                const response = await fetch(`${API_BASE_URL}/find-subdomains`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain: searchDomain, brute_force: bruteForce }),
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || `HTTP error! status: ${response.status}`);
                displayStaticResults("Found Subdomains", data.subdomains, "Found");
            } catch (err) {
                errorMessage.textContent = `Error: ${err.message}`;
            } finally {
                const scanDuration = ((Date.now() - scanStartTime) / 1000).toFixed(2);
                const [ipAddress, registrar] = await Promise.all([ fetchIpAddress(searchDomain), fetchRegistrar(searchDomain) ]);
                scanSummaryData = { hostname: searchDomain, ip_address: ipAddress, registrar, page_count: currentResults.length, scan_duration: scanDuration };
                setUILoading(false);
            }
        }
        
        function archiveUrl(link, index) {
            return new Promise((resolve) => {
                let statusSpan = null;
                if (index !== -1) {
                    statusSpan = document.getElementById(`status-${index}`);
                }

                const updateStatus = (text, colorClass, title = '') => {
                    if (statusSpan) {
                        statusSpan.textContent = text;
                        statusSpan.className = `text-sm font-medium ${colorClass} flex-shrink-0`;
                        statusSpan.title = title;
                    } else {
                        resultsSummary.textContent = text;
                        resultsSummary.className = `text-sm mb-4 ${colorClass}`;
                    }
                };

                updateStatus('Connecting...', 'text-gray-400');

                const fullUrl = link.startsWith('http') ? link : `https://${link}`;
                const eventSource = new EventSource(`${API_BASE_URL}/archive-url?url=${encodeURIComponent(fullUrl)}`);

                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    if (data.status) {
                        updateStatus(data.status, 'text-yellow-500');
                    }
                    if (data.success) {
                        updateStatus('Saved!', 'text-green-500');
                        eventSource.close();
                        resolve();
                    }
                    if (data.error) {
                        updateStatus('Failed!', 'text-red-500', data.error);
                        eventSource.close();
                        resolve();
                    }
                };
                eventSource.addEventListener('end', () => resolve());
                eventSource.onerror = () => {
                    updateStatus('Failed!', 'text-red-500', 'Connection error to the backend server.');
                    eventSource.close();
                    resolve();
                };
            });
        }

        async function archiveSelectedResults() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.result-checkbox:checked'));
            let itemsToArchive = [];

            if (selectedCheckboxes.length > 0) {
                itemsToArchive = selectedCheckboxes.map(cb => {
                    const link = cb.dataset.link;
                    const originalItem = currentResults.find(item => (typeof item === 'string' ? item : item.name) === link);
                    const originalIndex = currentResults.indexOf(originalItem);
                    return { link, index: originalIndex };
                });
            } else if (currentResults.length === 0 && urlInput.value) {
                itemsToArchive.push({ link: urlInput.value, index: -1 });
            } else {
                return;
            }

            const initialButtonText = archiveAllBtn.textContent;
            archiveAllBtn.disabled = true;
            archiveAllBtn.textContent = 'Archiving...';

            for (let i = 0; i < itemsToArchive.length; i++) {
                const item = itemsToArchive[i];
                resultsSummary.textContent = `Archiving ${i + 1} of ${itemsToArchive.length}...`;
                await archiveUrl(item.link, item.index);
                if (i < itemsToArchive.length - 1) await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            archiveAllBtn.textContent = initialButtonText;
            resultsSummary.textContent = originalResultsSummaryText;
            updateActionButtonsState();
        }

        async function saveAllLocalResults() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.result-checkbox:checked'));
            let itemsToSave = [];

            if (selectedCheckboxes.length > 0) {
                itemsToSave = selectedCheckboxes.map(cb => {
                    const link = cb.dataset.link;
                    const originalItem = currentResults.find(item => (typeof item === 'string' ? item : item.name) === link);
                    const originalIndex = currentResults.indexOf(originalItem);
                    
                    let fullUrl = link;
                    if (currentScanType === 'subdomain') {
                        fullUrl = `https://${link}`;
                    }
                    return { link: fullUrl, index: originalIndex };
                });
            } else if (currentResults.length === 0 && urlInput.value) {
                itemsToSave.push({ link: urlInput.value, index: -1 }); 
            } else {
                return;
            }

            const initialButtonText = saveAllLocalBtn.textContent;
            saveAllLocalBtn.disabled = true;
            saveAllLocalBtn.textContent = 'Saving...';

            for (let i = 0; i < itemsToSave.length; i++) {
                const item = itemsToSave[i];
                resultsSummary.textContent = `Saving ${i + 1} of ${itemsToSave.length}...`;
                await window.saveLocalCopy(item.link, item.index);
                if (i < itemsToSave.length - 1) await new Promise(resolve => setTimeout(resolve, 500)); 
            }
            
            saveAllLocalBtn.textContent = initialButtonText;
            resultsSummary.textContent = originalResultsSummaryText;
            updateActionButtonsState();
        }


        function generateSitemap(items) {
            const svg = d3.select("#sitemap-svg");
            svg.selectAll("*").remove(); 
            if (items.length === 0) return;
            const rootName = getDomainName(urlInput.value);
            const root = { name: rootName, children: [] };
            
            if (currentScanType === 'sitemap') {
                 items.forEach(link => {
                    try {
                        const url = new URL(link);
                        const pathParts = url.pathname.split('/').filter(p => p.length > 0);
                        let currentNode = root;
                        pathParts.forEach(part => {
                            let childNode = currentNode.children.find(child => child.name === part);
                            if (!childNode) { childNode = { name: part, children: [] }; currentNode.children.push(childNode); }
                            currentNode = childNode;
                        });
                    } catch (e) { console.error(`Invalid URL: ${link}`, e); }
                });
            } else if (currentScanType === 'subdomain') {
                items.forEach(item => {
                    const parts = item.name.replace(`.${rootName}`, '').split('.').reverse();
                    let currentNode = root;
                    parts.forEach((part, index) => {
                        let childNode = currentNode.children.find(child => child.name === part);
                        if (!childNode) {
                            childNode = { name: part, type: (index === parts.length - 1) ? item.type : undefined, fullName: (index === parts.length - 1) ? item.name : undefined, children: [] };
                            currentNode.children.push(childNode);
                        }
                        currentNode = childNode;
                    });
                });
            }
            
            const nodes = d3.hierarchy(root).descendants();
            const nodeHeight = 25;
            const dynamicHeight = Math.max(nodes.length * nodeHeight, document.getElementById('sitemap-container').clientHeight);
            svg.attr('height', dynamicHeight);
            const container = document.getElementById('sitemap-container');
            const width = container.clientWidth;
            const treeLayout = d3.tree().size([dynamicHeight - 40, width - 200]);
            const rootNode = d3.hierarchy(root);
            treeLayout(rootNode);

            const g = svg.append("g").attr("transform", "translate(100,20)");
            g.selectAll(".link").data(rootNode.links()).enter().append("path").attr("class", "link").attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));
            const node = g.selectAll(".node").data(rootNode.descendants()).enter().append("g")
                .attr("class", "node").attr("transform", d => `translate(${d.y},${d.x})`)
                .on("click", (event, d) => {
                    if (d.parent === null) return;
                    let fullUrl;
                    const rootName = getDomainName(urlInput.value);
                    if (currentScanType === 'sitemap') {
                        const path = d.ancestors().reverse().map(n => n.data.name).slice(1).join('/');
                        fullUrl = `https://${rootName}/${path}`;
                    } else if (currentScanType === 'subdomain') {
                        if (d.data.fullName) fullUrl = `https://${d.data.fullName}`;
                    }
                    if (fullUrl) window.open(fullUrl, '_blank');
                });
            node.append("circle").attr("r", 5);
            node.append("text").attr("dy", "0.31em").attr("x", d => d.children ? -8 : 8).attr("text-anchor", d => d.children ? "end" : "start").text(d => d.data.type ? `${d.data.name} (${d.data.type})` : d.data.name);
            svg.call(d3.zoom().on("zoom", (event) => g.attr("transform", event.transform)));
        }
        
        async function runAnalysis(endpoint, title, payload) {
            const analysisModalTitle = document.getElementById('analysis-modal-title');
            const analysisModalBody = document.getElementById('analysis-modal-body');
            analysisModalTitle.textContent = `Loading ${title}...`;
            analysisModalBody.innerHTML = '<div class="flex justify-center"><div class="spinner"></div></div>';
            analysisModal.classList.remove('hidden');
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Analysis failed');
                analysisModalTitle.textContent = title;
                let html = '';
                if (endpoint === '/detect-tech') {
                    html = data.technologies?.length > 0 ? `<ul class="list-disc list-inside space-y-2">${data.technologies.map(tech => `<li>${tech}</li>`).join('')}</ul>` : '<p>No specific technologies detected.</p>';
                } else if (endpoint === '/analyze-headers') {
                    html = `<dl class="space-y-2">${Object.entries(data.headers).map(([header, status]) => `<div class="flex justify-between"><dt class="font-medium">${header}:</dt><dd class="${status === 'Present' ? 'text-green-400' : 'text-red-400'}">${status}</dd></div>`).join('')}</dl>`;
                } else if (endpoint === '/check-links') {
                    const brokenLinks = Object.entries(data.link_statuses).filter(([_, status]) => status !== 200 && status !== 'Error');
                    const errorLinks = Object.entries(data.link_statuses).filter(([_, status]) => status === 'Error');
                    html = '';
                    if(brokenLinks.length > 0) {
                        html += `<h4 class="font-semibold mb-2">Broken Links (404, etc.):</h4><ul class="list-disc list-inside space-y-2 mb-4">${brokenLinks.map(([link, status]) => `<li><span class="font-medium">Status ${status}:</span> <a href="${link}" target="_blank" class="text-blue-400 hover:underline">${link}</a></li>`).join('')}</ul>`;
                    }
                     if(errorLinks.length > 0) {
                        html += `<h4 class="font-semibold mb-2">Network/SSL Errors:</h4><ul class="list-disc list-inside space-y-2">${errorLinks.map(([link, status]) => `<li><a href="${link}" target="_blank" class="text-blue-400 hover:underline">${link}</a></li>`).join('')}</ul>`;
                    }
                    if(html === '') {
                        html = '<p>No broken links found!</p>';
                    }
                }
                analysisModalBody.innerHTML = html;
            } catch (err) {
                analysisModalBody.innerHTML = `<p class="text-red-500">${err.message}</p>`;
            }
        }
        
        // --- Event Listeners ---
        exportCsvBtn.addEventListener('click', () => {
            const selectedCheckboxes = document.querySelectorAll('.result-checkbox:checked');
            if (selectedCheckboxes.length === 0) return;
            const selectedItems = Array.from(selectedCheckboxes).map(cb => {
                const link = cb.dataset.link;
                return currentScanType === 'subdomain' ? currentResults.find(item => item.name === link) : link;
            });
            const domain = getDomainName(urlInput.value) || 'scan_results';
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `${domain}_${timestamp}.csv`;
            let csvContent = "data:text/csv;charset=utf-8,";
            if (currentScanType === 'subdomain') {
                csvContent += "Subdomain,Record Type\r\n";
                selectedItems.forEach(item => { csvContent += `${item.name},${item.type}\r\n`; });
            } else {
                csvContent += "Found Sites\r\n";
                selectedItems.forEach(link => { csvContent += `${link}\r\n`; });
            }
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        archiveAllBtn.addEventListener('click', archiveSelectedResults);
        saveAllLocalBtn.addEventListener('click', saveAllLocalResults);
        scanButton.addEventListener('click', performStreamingScan);
        subdomainButton.addEventListener('click', performSubdomainSearch);
        
        sitemapBtn.addEventListener('click', () => {
            const legend = document.getElementById('sitemap-legend');
            const mapTitle = document.getElementById('sitemap-modal-title');
            mapTitle.textContent = currentScanType === 'sitemap' ? 'Visual Sitemap' : 'Visual Subdomain Map';
            if (scanSummaryData) {
                legend.innerHTML = `<h4 class="font-bold text-sm mb-2">Scan Info</h4><p><strong>Host:</strong> ${scanSummaryData.hostname}</p><p><strong>IP Address:</strong> ${scanSummaryData.ip_address}</p><p><strong>Provider:</strong> ${scanSummaryData.registrar}</p><p><strong>Items Found:</strong> ${scanSummaryData.page_count}</p><p><strong>Scan Time:</strong> ${scanSummaryData.scan_duration}s</p>`;
            } else {
                legend.innerHTML = '<p>Scan summary not available.</p>';
            }
            sitemapModal.classList.remove('hidden');
            setTimeout(() => { generateSitemap(currentResults); }, 100); 
        });

        resultsList.addEventListener('change', (event) => {
            if (event.target.classList.contains('result-checkbox')) updateActionButtonsState();
        });
        selectAllCheckbox.addEventListener('change', (event) => {
            document.querySelectorAll('.result-checkbox').forEach(checkbox => checkbox.checked = event.target.checked);
            updateActionButtonsState();
        });
        
        closeSitemapModalBtn.addEventListener('click', () => sitemapModal.classList.add('hidden'));
        closeAnalysisModalBtn.addEventListener('click', () => analysisModal.classList.add('hidden'));
        closeDiffModalBtn.addEventListener('click', () => diffModal.classList.add('hidden'));
        
        settingsBtn.addEventListener('click', async () => {
            settingsModal.classList.remove('hidden');
            settingsStatusMessage.textContent = '';
            proxyTestResultsContainer.classList.add('hidden');
            proxyTestResults.innerHTML = '';
            try {
                const response = await fetch(`${API_BASE_URL}/get-settings`);
                const data = await response.json();
                if (response.ok) {
                    proxyTextarea.value = data.proxies;
                    enableProxiesCheckbox.checked = data.enabled;
                    archiveFolderInput.value = data.archive_folder;
                    currentArchiveFolder = data.archive_folder; 
                    // NEW: Populate cookie fields
                    cookieDomainInput.value = data.cookie_domain || '';
                    cookieNameInput.value = data.cookie_name || '';
                    cookieValueInput.value = data.cookie_value || '';
                } else {
                    throw new Error(data.error || 'Failed to load settings');
                }
            } catch (e) {
                settingsStatusMessage.textContent = 'Error loading settings.';
                settingsStatusMessage.className = 'text-sm mt-2 text-red-500';
            }
        });
        closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
        
        testProxiesBtn.addEventListener('click', async () => {
            const proxies = proxyTextarea.value.split('\n').map(p => p.trim()).filter(p => p.length > 0);
            if (proxies.length === 0) {
                proxyTestResultsContainer.classList.remove('hidden');
                proxyTestResults.innerHTML = '<p class="text-yellow-400">Please enter at least one proxy to test.</p>';
                return;
            }

            proxyTestResultsContainer.classList.remove('hidden');
            proxyTestResults.innerHTML = '<div class="flex justify-center"><div class="spinner"></div></div>';
            settingsStatusMessage.textContent = `Testing ${proxies.length} proxies...`;
            settingsStatusMessage.className = 'text-sm mt-2 text-yellow-500';

            try {
                const response = await fetch(`${API_BASE_URL}/test-proxies`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ proxies }),
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to run test');

                proxyTestResults.innerHTML = '';
                let workingCount = 0;
                
                if (data.results && data.results.length > 0) {
                     data.results.forEach(res => {
                        const p = document.createElement('p');
                        p.className = 'font-mono';
                        if (res.status === 'Working') {
                            workingCount++;
                            p.className += ' text-green-400';
                            p.textContent = `[SUCCESS] ${res.proxy} (IP: ${res.ip})`;
                        } else {
                            p.className += ' text-red-400';
                            p.textContent = `[FAILED]  ${res.proxy} (${res.status})`;
                        }
                        proxyTestResults.appendChild(p);
                    });
                } else {
                     proxyTestResults.innerHTML = '<p class="text-gray-400">No results returned from backend.</p>';
                }
               
                settingsStatusMessage.textContent = `Test complete: ${workingCount} of ${proxies.length} proxies are working.`;
                settingsStatusMessage.className = 'text-sm mt-2 text-green-500';

            } catch (e) {
                settingsStatusMessage.textContent = `Error: ${e.message}`;
                settingsStatusMessage.className = 'text-sm mt-2 text-red-500';
                proxyTestResults.innerHTML = `<p class="text-red-500">Error during test: ${e.message}</p>`;
            }
        });

        saveSettingsBtn.addEventListener('click', async () => {
            const proxies = proxyTextarea.value;
            const enabled = enableProxiesCheckbox.checked;
            const archive_folder = archiveFolderInput.value;
            // NEW: Get cookie data
            const cookie_domain = cookieDomainInput.value;
            const cookie_name = cookieNameInput.value;
            const cookie_value = cookieValueInput.value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/update-settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        proxies, 
                        enabled, 
                        archive_folder,
                        cookie_domain,
                        cookie_name,
                        cookie_value 
                    }),
                });
                const data = await response.json();
                if (response.ok) {
                    settingsStatusMessage.textContent = data.message;
                    settingsStatusMessage.className = 'text-sm mt-2 text-green-500';
                    currentArchiveFolder = archive_folder; 
                } else {
                    throw new Error(data.error || 'Failed to save');
                }
            } catch (e) {
                settingsStatusMessage.textContent = e.message;
                settingsStatusMessage.className = 'text-sm mt-2 text-red-500';
            }
        });

        aboutBtn.addEventListener('click', () => aboutModal.classList.remove('hidden'));
        closeAboutModalBtn.addEventListener('click', () => aboutModal.classList.add('hidden'));

        schedulerBtn.addEventListener('click', () => {
            schedulerModal.classList.remove('hidden');
            loadSchedules();
        });
        closeSchedulerModalBtn.addEventListener('click', () => schedulerModal.classList.add('hidden'));

        historyBtn.addEventListener('click', async () => {
             try {
                const response = await fetch(`${API_BASE_URL}/get-last-results`);
                const data = await response.json();
                if (data.domain && data.subdomains) {
                    currentScanType = 'subdomain';
                    displayStaticResults(`Saved Results for ${data.domain}`, data.subdomains, "Loaded");
                    urlInput.value = data.domain; 
                } else {
                    errorMessage.textContent = 'No previous results found to load.';
                    setTimeout(() => errorMessage.textContent = '', 3000);
                }
            } catch (e) {
                console.error("Could not load last results.", e);
                errorMessage.textContent = 'Error loading previous results.';
                setTimeout(() => errorMessage.textContent = '', 3000);
            }
        });
        
        archivesBtn.addEventListener('click', async () => {
            localArchivesList.innerHTML = '<div class="flex justify-center"><div class="spinner"></div></div>';
            localArchiveModal.classList.remove('hidden');
            try {
                const response = await fetch(`${API_BASE_URL}/get-local-archives`);
                const files = await response.json();
                if (response.ok) {
                    if (files.length === 0) {
                        localArchivesList.innerHTML = '<p class="text-gray-400">No local archives found.</p>';
                        return;
                    }
                    localArchivesList.innerHTML = '';
                    files.forEach(file => {
                        const a = document.createElement('a');
                        a.href = `${API_BASE_URL}/local_archives/${file}`;
                        a.textContent = file;
                        a.target = '_blank';
                        a.className = 'block p-2 text-blue-400 hover:underline hover:bg-gray-700 rounded';
                        localArchivesList.appendChild(a);
                    });
                } else {
                    throw new Error(files.error || 'Failed to load archives');
                }
            } catch (e) {
                localArchivesList.innerHTML = `<p class="text-red-500">${e.message}</p>`;
            }
        });
        closeLocalArchiveModalBtn.addEventListener('click', () => localArchiveModal.classList.add('hidden'));


        saveScheduleBtn.addEventListener('click', async () => {
            const domain = scheduleDomainInput.value;
            const startDate = scheduleStartDate.value;
            const frequency = scheduleFrequency.value;

            if (!domain || !startDate) {
                scheduleStatusMessage.textContent = 'Please provide a domain and a start date.';
                scheduleStatusMessage.className = 'text-sm mt-3 text-red-500';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/schedule-scan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain, start_date: startDate, frequency }),
                });
                const data = await response.json();
                if (response.ok) {
                    scheduleStatusMessage.textContent = data.message;
                    scheduleStatusMessage.className = 'text-sm mt-3 text-green-500';
                    loadSchedules(); 
                } else {
                    throw new Error(data.error || 'Failed to save schedule');
                }
            } catch (e) {
                scheduleStatusMessage.textContent = e.message;
                scheduleStatusMessage.className = 'text-sm mt-3 text-red-500';
            }
        });

        techBtn.addEventListener('click', () => runAnalysis('/detect-tech', 'Technology Stack', { url: urlInput.value }));
        headersBtn.addEventListener('click', () => runAnalysis('/analyze-headers', 'Security Headers', { url: urlInput.value }));
        linksBtn.addEventListener('click', () => {
            if (currentResults.length === 0) {
                errorMessage.textContent = 'No links found to check. Please run a "Scan Site" first.';
                setTimeout(() => errorMessage.textContent = '', 3000);
                return;
            }
            const urlsToCheck = currentResults.map(item => typeof item === 'string' ? item : item.name);
            runAnalysis('/check-links', 'Broken Link Check', { urls: urlsToCheck });
        });
        diffMainBtn.addEventListener('click', () => {
            const url = urlInput.value;
            if (url) {
                window.runDiffCheck(url, -1);
            } else {
                errorMessage.textContent = 'Please enter a URL in the input box first.';
            }
        });

      });
    </script>
</body>
</html>

